---
title: "Challenge 03 -- Solution"
format: html
author: Sebastian Sauer
date: today
number-sections: true
toc: true
---




# Daten verstehen



## Setup


```{r}
library(tidyverse)
#library(stringr)  # Strings verarbeiten
library(here)  # liest aktuelles Verzeichnis aus
library(janitor)
#library(lubridate)  # Mit Zeitangaben arbeiten
library(tictoc)
library(data.table)
```




Wir laden den Datensatz, wie im letzten Schritt herausgegangen:

```{r}
#| eval: true
tic()
d_file_path <- "https://raw.githubusercontent.com/sebastiansauer/hans-hackathon2025/refs/heads/main/objects/d_students_only.csv"
d_input <- read_csv(d_file_path,
                    col_types = cols(.default = "c"))
toc()
```


```{r}
d_input_names_sanitized <- 
  d_input |> clean_names()

names(d_input_names_sanitized) |> 
  head(10)
```


```{r}
d_input_names_sanitized |> 
  select(1:20) |> 
  glimpse()
```


## Lösungen

### 1 Pivotieren

Mit `id_visit` als ID:

```{r}
tic()
d_long_idvisit <-
  d_input_names_sanitized |> 
  select(-x1) |> 
  pivot_longer(cols = -id_visit)
toc()
```


```{r}
glimpse(d_long_idvisit)
```



### Pivotieren mit `fingerprint` als ID

```{r}
tic()
d_long_fingerprint <-
  d_input_names_sanitized |> 
  select(-x1) |> 
  pivot_longer(cols = -fingerprint)
toc()
```


```{r}
glimpse(d_long_fingerprint)
```


### Pivotieren mit beiden ID-Variablen


```{r}
tic()
d_long_idvisit_fingerprint <-
  d_input_names_sanitized |> 
  select(-x1) |> 
  pivot_longer(cols = -c(id_visit, fingerprint))
toc()
```


```{r}
glimpse(d_long_idvisit_fingerprint)
```


### Pivotieren und Begrenzen Sie beim Pivotieren die Spalten auf die Spaltentypen - id_visit


```{r}
d_input_names_sanitized_only_subtitle_cols <- 
d_input_names_sanitized |> 
  select(id_visit, contains("subtitle")) 

tic()
d_long_idvisit_only_subtitle_cols_idvisit <-
  d_input_names_sanitized_only_subtitle_cols |> 
  pivot_longer(cols = -id_visit)
toc()
```



```{r}
glimpse(d_long_idvisit_only_subtitle_cols_idvisit)
```

BONUS:

Den Zeitverbrauch kann man sich mit `profvis` näher anschauen:

```{r}
#| eval: false
library(profvis)
profvis({
  d_long_idvisit_only_subtitle_cols_idvisit <-
    d_input_names_sanitized_only_subtitle_cols %>%
    pivot_longer(cols = -id_visit)
})
```






### Pivotieren und Begrenzen Sie beim Pivotieren die Spalten auf die Spaltentypen - fingerprint



```{r}
d_input_names_sanitized_only_subtitle_cols_fingerprint <- 
d_input_names_sanitized |> 
  select(fingerprint, contains("subtitle")) 

tic()
d_long_idvisit_only_subtitle_cols_fingerprint <-
  d_input_names_sanitized_only_subtitle_cols_fingerprint |> 
  pivot_longer(cols = -fingerprint)
toc()
```


```{r}
glimpse(d_long_idvisit_only_subtitle_cols_fingerprint)
```









### Pivotieren und Begrenzen Sie beim Pivotieren die Spalten auf die Spaltentypen - idvisit und fingerprint



```{r}
d_input_names_sanitized_only_subtitle_cols_idvisit_fingerprint <- 
d_input_names_sanitized |> 
  select(id_visit, fingerprint, contains("subtitle")) 

tic()
d_long_idvisit_only_subtitle_cols_idvisit_fingerprint <-
  d_input_names_sanitized_only_subtitle_cols_idvisit_fingerprint |> 
  pivot_longer(cols = -c(id_visit, fingerprint))
toc()
```


```{r}
glimpse(d_long_idvisit_only_subtitle_cols_idvisit_fingerprint)
```


### rüfen Sie, ob es stimmt, dass in der Spalte  ...


```{r}
d_long_idvisit_only_subtitle_cols_idvisit_fingerprint %>%
  pull(name) %>%
  str_remove("\\d+") %>%        # remove digits from each string
  unique() %>%                  # keep only unique values
  length()                      # count them
```

Ja, ist konstant ohne die Zahlen in der Mitte


### Zahl extrahieren aus `name`

```{r}
d_long_idvisit_only_subtitle_cols_idvisit_fingerprint |> 
  mutate(id = str_extract(name, "\\d+")) |> 
  select(-name)
```


### Schneller als `pivot_longer`

`data.table` ist eines der bekanntesten R-Pakete. Es glänzt durch Geschwindigkeit.


```{r}
vars_to_pivot <- 
  d_input_names_sanitized %>%
  select(contains("action_details_")) %>%
  names()

DT <- as.data.table(d_input_names_sanitized)

tic()
out <- melt(DT,
    id.vars = c("id_visit", "fingerprint"),
    measure.vars = vars_to_pivot,
    variable.name = "name",
    value.name = "value"
  )
toc()
```


### Bonus: Wer ist schneller?

![](https://timfarewell.co.uk/wp-content/uploads/2019/06/there-must-be-a-faster-way-Page-01-768x274.png)



`data.table` ist deutlich schneller als `tidyverse`: 

- https://duckdblabs.github.io/db-benchmark/
- https://towardsdatascience.com/data-table-speed-with-dplyr-syntax-yes-we-can-51ef9aaed585/
- https://timfarewell.co.uk/is-data-table-or-dplyr-faster-at-summarising-data/
- https://codepointtech.com/scale-tidyverse-to-big-data-master-dtplyr-for-dplyr-data-table/





## Outro

Als RDS-Datei:

```{r}
tic()
write_rds(d_long_idvisit_only_subtitle_cols_idvisit,
          paste0(here(),"/objects/d_long_idvisit_only_subtitle_cols_idvisit.rds"))
toc()

write_rds(d_long_idvisit_only_subtitle_cols_idvisit_fingerprint,
          paste0(here(),"/objects/d_long_idvisit_only_subtitle_cols_idvisit_fingerprint.rds"))
```


Als Text-Datei:


```{r}
tic()
write_csv(d_long_idvisit_only_subtitle_cols_idvisit,
          paste0(here(),"/objects/d_long_idvisit_only_subtitle_cols_idvisit.csv"))
toc()

write_csv(d_long_idvisit_only_subtitle_cols_idvisit_fingerprint,
          paste0(here(),"/objects/d_long_idvisit_only_subtitle_cols_idvisit_fingerprint.csv"))
```


# SessionInfo

```{r}
sessionInfo()
```

