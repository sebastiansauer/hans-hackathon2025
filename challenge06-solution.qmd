---
title: "Challenge 06 -- Solution"
# format: 
#   typst:
#     out-width: 100%
#     fig-width: 7  # inches
  
author: Sebastian Sauer
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M')`"
number-sections: true
toc: true
# execute:
#   cache: true
---


Betrachten Sie dazu die [Targets-Datei auf Github](https://github.com/sebastiansauer/hans-hackathon2025/blob/main/challenge06-solution.R).




# Setup

## Libs
```{r load-libs}
#| include: false
library(tidyverse)
library(lubridate)
library(gt)
library(visdat)
# library(data.table)
# library(collapse)
library(targets)
library(ggstatsplot)
library(easystats)
library(scales)
library(gt)
library(ggpubr)
```


## Other setup

```{r setup}
source("_common.r")
list.files("funs", full.names = TRUE) |>
  purrr::walk(source)

options(digits = 3)
options(tinytable_tt_digits = 2)
```


## Load Targets

```{r load-targets}
tar_load(c(
  data_prepped, 
  visitduration, 
  time_spent,
  time_visit_wday,
  time_visit_wday_fingerprint,
  course_and_uni_per_visit,
  time_spent_w_course_university,
  n_action_w_date
))
```


# Musterlösung    


## Berechnen Sie die Verweildauer: Wieviel Zeit verbringen die Nutzer pro Visit?


### Spalte `visitduration`

Dafür gibt es eine Spalte:

```{r}
visitduration |> 
  select(visitduration)
```

```{r}
visitduration_desc <-
  visitduration |> 
  select(visitduration) |> 
  describe_distribution(centrality = c("mean", "median"))
```

Im Standard wird in *Sekunden* gezählt.

```{r}
mean(visitduration$visitduration)
```

```{r}
duration_hms <- function(x) {
  s <- round(as.numeric(x))
  sprintf(
    "%02d:%02d:%02d",
    s %/% 3600,
    (s %% 3600) %/% 60,
    s %% 60
  )
}

visitduration_desc[c("Mean", "MAD", "Median", "SD")] <-
  lapply(visitduration_desc[c("Mean","MAD", "Median", "SD")], duration_hms)

visitduration_desc
```


```{r}
visitduration |>
  ggplot(aes(x = visitduration)) + # minutes
  geom_histogram(binwidth = 10) +
  #scale_x_time() +
  theme_minimal() +
  labs(y = "n", x = "Verweildauer in HaNS pro Visit in hh:mm:ss") +
  scale_x_time(breaks = pretty_breaks()) +
  geom_vline(xintercept = median(visitduration$visitduration) / 60, color = "blue", linetype = "dashed") +
  annotate("label", x = median(visitduration$visitduration) / 60, 
           y = Inf, label = "Median", vjust = 1.5, color = "blue")
  
```


### Selbstgebastelt

```{r time_spent_summary}
time_spent_summary <- 
time_spent |>
  mutate(time_diff_minutes = time_length(time_diff, unit = "minute")) |>
  summarise(
    mean_time_diff = round(mean(time_diff_minutes), 2),
    median_time_diff = round(median(time_diff_minutes, 2)),
    iqr_time_diff = round(IQR(time_diff_minutes, 2)),
    sd_time_diff = sd(time_diff_minutes),
    min_time_diff = min(time_diff_minutes), # shortest duration
    max_time_diff = max(time_diff_minutes) # longest
  )

time_spent_summary |> 
  gt() |> 
  tab_header(title = "Duration statistics per visit (in minutes)")
```


```{r}
time_spent |>
  mutate(time_diff_minutes = time_diff / 60) |>
  ggplot(aes(x = time_diff_minutes)) + # minutes
  geom_histogram(binwidth = 10) +
  #scale_x_time() +
  theme_minimal() +
  labs(y = "n", x = "Verweildauer in HaNS pro Visit in hh:mm:ss") +
  scale_x_time(breaks = pretty_breaks()) +
  geom_vline(xintercept = median(time_spent$time_diff) / 60, color = "blue", linetype = "dashed") +
  annotate("label", x = median(time_spent$time_diff) / 60, 
           y = Inf, label = "Median", vjust = 1.5, color = "blue")
```

## Berechnen Sie die Verweildauer pro Nutzer. Berichten Sie die Verteilung.


```{r}
#| warning: false
visitduration_by_fingerprint <- 
visitduration |> 
  select(fingerprint, visitduration) |> 
  group_by(fingerprint) |> 
  summarise(visitduration = mean(visitduration, na.rm = TRUE))
```


```{r}
visitduration_by_fingerprint |> 
  describe_distribution(select = visitduration)
```


## Berechnen Sie die Anzahl der Besuche im Zeitverlauf (pro Woche).

```{r}
time_spent_by_week <-
  time_spent |>
  mutate(week_start = floor_date(time_min, "week")) |>
  mutate(
    week_num = lubridate::week(week_start),
    year = lubridate::year(week_start)
  ) |>
  group_by(week_num, year) |>
  summarise(
    time_spent_week_median = as.numeric(median(time_diff, na.rm = TRUE), units = "mins"),
    time_spent_week_sd = sd(time_diff, na.rm = TRUE) / 60,
    time_spent_week_iqr = IQR(time_diff, na.rm = TRUE) / 60
  ) |>
  arrange(year, week_num) |> 
  ungroup()

time_spent_by_week |> 
  gt() |> 
  fmt_number(columns = c(3,4, 5),
              decimals = 2)
```


```{r}
time_spent_by_week_start <-
  time_spent |>
  mutate(week_start = lubridate::floor_date(time_min, "week")) |>
  mutate(
    week_num = lubridate::week(week_start),
    year = lubridate::year(week_start)
  ) |>
  group_by(week_start, year) |>
  summarise(
    time_spent_week_avg = mean(time_diff, na.rm = TRUE),
    time_spent_week_median = median(time_diff, na.rm = TRUE),    
    time_spent_week_sd = sd(time_diff, na.rm = TRUE)
  )

time_spent_by_week_start |>
  ggplot(aes(x = week_start, y = time_spent_week_median)) +
  geom_line(group = 1, color = "grey60") +
  scale_y_time(labels = scales::time_format("%H:%M:%S")) +
  labs(x = "Datum", y = "Durchschnittliche Verweildauer pro Visit (in hh:mm:ss)") +
  # --- Highlight March–July (approx 1 Mar to 31 Jul) ---
  annotate(
    "rect",
    xmin = as.Date("2023-03-01"),
    xmax = as.Date("2023-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  annotate(
    "rect",
    xmin = as.Date("2024-03-01"),
    xmax = as.Date("2024-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +
  annotate(
    "rect",
    xmin = as.Date("2025-03-01"),
    xmax = as.Date("2025-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  # --- Highlight October–February (semester break or 2nd term) ---
  annotate(
    "rect",
    xmin = as.Date("2023-10-01"),
    xmax = as.Date("2024-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  ) +
  # annotate("rect",
  #          xmin = as.Date("2024-10-01"), xmax = as.Date("2024-02-28"),
  #          ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "orange") +
  annotate(
    "rect",
    xmin = as.Date("2024-10-01"),
    xmax = as.Date("2025-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  ) +

  geom_point()
```


## An welchen Tagen und zu welcher Zeit kommen die Besucher zu HaNS?

```{r}
# Define a vector with the names of the days of the week
# Note: Adjust the start of the week (Sunday or Monday) as per your requirement
days_of_week <- c(
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday",
  "Sunday"
)

# Replace numbers with day names
time_visit_wday$dow2 <- factor(
  days_of_week[time_visit_wday$dow],
  levels = days_of_week
)

time_visit_wday_fingerprint$dow2 <- factor(
  days_of_week[time_visit_wday_fingerprint$dow],
  levels = days_of_week
)
```

## Zu welchen Uhrzeiten wird die Seite bevorzugt besucht?
```{r}
time_visit_wday |>
  as_tibble() |>
  count(hour) |>
  mutate(prop = n / sum(n)) |>
  ggplot(aes(x = hour, y = prop)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "HaNS-Nutzer sind keine Frühaufsteher",
    x = "Uhrzeit",
    y = "Anteil"
  )
```

```{r}
time_visit_wday |>
  as_tibble() |>
  count(hour) |>
  mutate(prop = n / sum(n)) |>
  ggplot(aes(x = hour, y = prop)) +
  geom_col() +
  theme_minimal() +
  coord_polar()
```

## An welchen Tagen und zu welcher Zeit kommen die Besucher zu HaNS?

```{r}
time_visit_wday |>
  as_tibble() |>
  count(dow2) |>
  mutate(prop = n / sum(n)) |>
  ggplot(aes(x = dow2, y = prop)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "Verteilung der HaNS-Logins nach Wochentagen",
    x = "Wochentag",
    y = "Anteil"
  )
```



```{r}
time_visit_wday |>
  as_tibble() |>
  count(dow2, hour) |>
  group_by(dow2) |>
  mutate(prop = n / sum(n)) |>
  ggplot(aes(x = hour, y = prop)) +
  geom_col() +
  facet_wrap(~dow2) +
  theme_minimal() +
  labs(
    title = "Verteilung der HaNS-Logins nach Wochentagen und Uhrzeiten",
    x = "Wochentag",
    y = "Anteil"
  )
```


## Wie ist die Verteilung der Visits?

```{r}
time2 <-
  time_visit_wday |>
  ungroup() |>
  mutate(date = as.Date(date_time)) |>
  mutate(month_start = floor_date(date_time, "month"))

time2 |>
  ggplot(aes(x = date, y = hour)) +
  geom_bin2d(binwidth = c(1, 1)) + # (1 day, 1 hour)
  scale_x_date(date_breaks = "1 month") +
  theme(legend.position = "bottom") +
  scale_fill_viridis_c() +
  labs(caption = "Each x-bin maps to one week") +
  scale_x_date(breaks = breaks_pretty()) +
  labs(
    caption = "Vertical dashed lines shows the median.",
    title = "Most users to only a few actions, but some do many.",
    x = "Number of actions per visit",
    y = "Number of visits"
  ) +

  # --- Highlight March–July (approx 1 Mar to 31 Jul) ---
  annotate(
    "rect",
    xmin = as.Date("2023-03-01"),
    xmax = as.Date("2023-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  annotate(
    "rect",
    xmin = as.Date("2024-03-01"),
    xmax = as.Date("2024-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +
  annotate(
    "rect",
    xmin = as.Date("2025-03-01"),
    xmax = as.Date("2025-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  # --- Highlight October–February (semester break or 2nd term) ---
  annotate(
    "rect",
    xmin = as.Date("2023-10-01"),
    xmax = as.Date("2024-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  ) +
  # annotate("rect",
  #          xmin = as.Date("2024-10-01"), xmax = as.Date("2024-02-28"),
  #          ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "orange") +
  annotate(
    "rect",
    xmin = as.Date("2024-10-01"),
    xmax = as.Date("2025-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  )  +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  scale_x_date(limits = as.Date(c("2025-03-02", "2025-07-13")))
```




## Geben Sie den Zeitraum der Nutzung an (von bis ). Hier geht es um insgesamte erste (bzw. letzte) Nutzung über alle User hinweg. Gefragt ist der älteste und neueste Time Stamp, den der Server insgesamt/überhaupt protokolliert hat.

```{r}
min_max_time <-
  n_action_w_date |>
  summarise(
    time_min = min(date_time_start, na.rm = T),
    time_max = max(date_time_start, na.rm = T)
  )

min_max_time |>
  gt()
```

## Wie ist die Verteilung der Visits?

Hier im Zeitverlauf

```{r}
time_visit_wday_summary_week <-
  time_visit_wday |>
  ungroup() |>
  mutate(week_start = floor_date(date_time, "week")) |>
  mutate(week_num = week(date_time), year_num = year(date_time))


time_visit_wday_summary_week_summarized_dateformat <-
  time_visit_wday_summary_week |>
  group_by(week_start) |>
  summarise(n = n())
```


```{r}
time_visit_wday_summary_week_summarized_dateformat_plot <- 
time_visit_wday_summary_week_summarized_dateformat |>
  ggplot(aes(x = week_start, y = n)) +
  geom_line(group = 1, color = "grey60") +
  geom_point() +
  geom_smooth(method = "gam", se = FALSE, color = "blue") +
  labs(
    title = "The number of visits is increasing and reflects the teaching periods of the semesters.",
    x = "week number/year"
  ) +

  # --- Highlight March–July (approx 1 Mar to 31 Jul) ---
  annotate(
    "rect",
    xmin = as.Date("2023-03-01"),
    xmax = as.Date("2023-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  annotate(
    "rect",
    xmin = as.Date("2024-03-01"),
    xmax = as.Date("2024-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +
  annotate(
    "rect",
    xmin = as.Date("2025-03-01"),
    xmax = as.Date("2025-07-31"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "skyblue"
  ) +

  # --- Highlight October–February (semester break or 2nd term) ---
  annotate(
    "rect",
    xmin = as.Date("2023-10-01"),
    xmax = as.Date("2024-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  ) +
  # annotate("rect",
  #          xmin = as.Date("2024-10-01"), xmax = as.Date("2024-02-28"),
  #          ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "orange") +
  annotate(
    "rect",
    xmin = as.Date("2024-10-01"),
    xmax = as.Date("2025-02-28"),
    ymin = -Inf,
    ymax = Inf,
    alpha = 0.2,
    fill = "orange"
  ) 

time_visit_wday_summary_week_summarized_dateformat_plot
```


```{r}
time_visit_wday_summary_week_summarized_dateformat_plot +
  scale_x_date(limits = as.Date(c("2025-03-02", "2025-07-13")))
```

## Brechen Sie die Verteilung der Visits auf nach folgenden Untergruppen: Module und Hochschule.


### Hochschule

```{r}
course_and_uni_per_visit |>
  count(university, sort = TRUE) |> 
  gt()
```

```{r}
course_and_uni_per_visit |>
  count(university) |>
  drop_na() |>
  ggplot(aes(y = reorder(university, n), x = n)) +
  geom_col() +
  theme_minimal() +
  labs(
    title = "TH Nürnberg hosts the most courses on HaNS by far.",
    y = "University"
  )
```



### Module

```{r}
time_spent_w_course_university |>
  count(course, sort = TRUE) |> 
  gt()
```

```{r}
time_spent_w_course_university |>
  count(year, course) |>
  drop_na() |>
  ggplot(aes(x = n, y = course, fill = factor(year), )) +
  geom_col(position = "dodge") +
  labs(title = "The course 'GeSOA' is the most active course on HaNS.",
       fill = "Jahr") +
  theme(legend.position = c(.9, .9),
        legend.justification = c("right", "top"))
```


## Unterscheiden sich die Anzahl der Visits zwischen Vorlesungszeit und Semesterferien?

Keine Vorlesungszeit in den Daten enthalten



## Verändert sich die Verweildauer im Zeitverlauf (nimmt sie zu oder ab?)? Analysebasis: Woche. Berechnen Sie eine Regression dazu.


```{r}
time_spent_by_week |> 
  ggplot(aes(x = week_num, y = time_spent_week_median)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
lm_visitduration_by_week <-
  lm(time_spent_week_median ~ week_num, data = time_spent_by_week)

parameters(lm_visitduration_by_week) |> 
  print_md()
```


## Gibt es einen statistischen Zusammenhang von Modul/Lehrveranstaltung und Verweildauer?

```{r}
time_spent_w_course_university_summary <-
  time_spent_w_course_university |>
  group_by(floor_date_month) |>
  summarise(
    distinct_courses_n = n_distinct(course),
    diff_time_mean = round(mean(time_diff, na.rm = TRUE), 2),
    n = n()
  )

time_spent_w_course_university_summary |> 
  gt() |> 
  fmt_number(columns = where(is.numeric),
             decimals = 2)
```

```{r}
time_spent_w_course_university_summary |>
  ggplot(aes(x = distinct_courses_n, y = diff_time_mean)) +
  geom_point() +
  scale_y_time(labels = scales::time_format("%M:%S")) +
  labs(
    y = "Average visit duration (m:s)",
    x = "No. of distinct courses per month"
  )
```

```{r}
time_spent_w_course_university_summary |> 
  mutate(diff_time_mean_num = as.numeric(diff_time_mean)) |> 
  correlation()
```

## Gibt es einen statistischen Zusammenhang von Modul/Lehrveranstaltung und der Anzahl der Visits?


```{r}
time_spent_w_course_university_summary |>
  ggplot(aes(x = distinct_courses_n, y = n)) +
  geom_point() +
  labs(y = "No. of visits per month", x = "No. of distinct courses per month")
```



# Debrief

## Targets-Objekte


```{r tar-obs}
targets::tar_manifest() |>
  select(name) |>
  #print(n = Inf) |>
  knitr::kable()
```

## Pipeline-Graph


```{r tar-visnetwork}
#| dpi: 300
#| eval: false
tar_visnetwork(targets_only = TRUE,
               outdated = TRUE)
```



```{r}
tar_glimpse()
```



## sessionInfo

```{r}
sessioninfo::session_info()
```
